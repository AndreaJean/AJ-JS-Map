function createInfoWinHtml(e){return"normal"===e.type?normalWin(e):"custom"===e.type&&customWin(e)}function normalWin(e){var t='<div class="ic-map-infoWin-title">'+e.title+'<i id="icMapInfoWinCancleBtn" class="icon iconfont icon-tubiao_guanbi"></i></div><span class="ic-map-infoWin-triangle"></span><div class="ic-map-infoWin-content">';return JM_util.checkNull(e.img)&&(t+='<span class="ic-map-infoWin-img" style="width:'+e.imgSize[0]+";height:"+e.imgSize[1]+';"><img src="'+e.img+'"/></span>'),JM_util.checkNull(e.content)&&(t+="  <p>"+e.content+"</p>"),e.button.length&&e.button.forEach(e=>{t+='<button id="'+e.id+'">'+e.label+"</button>"}),t+="</div>",t}function customWin(e){var t='<div class="ic-map-infoWin-title">'+e.title+'<i id="icMapInfoWinCancleBtn" class="icon iconfont icon-tubiao_guanbi"></i></div><span class="ic-map-infoWin-triangle"></span><div class="ic-map-infoWin-content">';return JM_util.checkNull(e.contentHtml)&&(t+=e.contentHtml),e.button.length&&e.button.forEach(e=>{t+='<button id="'+e.id+'">'+e.label+"</button>"}),t+="</div>",t}function createMemuHtml(e){var t="<ul>";return e.menuItem.length&&e.menuItem.forEach(e=>{t+='<li id="'+e.id+'">',JM_util.checkNull(e.iconClass)&&(t+='<i class="'+e.iconClass+'"></i>'),t+=e.label+"</li>"}),t+="</ul>",t}const JM_B_util={newPoint:e=>new BMap.Point(...e),creatPoint(e){var t=null;return t=e.point?e.point:this.newPoint([e.lng,e.lat]),t},newIcon(e){var t=e.url,i=new BMap.Size(...e.position),n=null;n=JM_util.checkNull(e.anchor)?new BMap.Size(...e.anchor):new BMap.Size(.5*e.position[0],.5*e.position[1]);var o=new BMap.Size(...e.imageOffset),a=new BMap.Size(...e.imageSize),l={anchor:n,imageOffset:o,imageSize:a},s=new BMap.Icon(t,i,l);return s},newMarker(e){var t=this.creatPoint(e),i=e.markerStyle,n=null;if(i.isSymbol)if(i.symbolStyle.anchor=new BMap.Size(...i.symbolStyle.anchor),JM_util.checkNull(i.symbolPts))n=new BMap.Symbol(i.symbolPts,i.symbolStyle);else{var o=this.getSymbolShapeType(i.SymbolShapeType);n=new BMap.Symbol(o,i.symbolStyle)}else n=this.newIcon(i);var a={title:e.title||"",icon:n},l=new BMap.Marker(t,a);return this.addAttributes(l,e),l},newLabel(e){var t=this.newPoint([e.lng,e.lat]),i=e.labelStyle;i.transform+=" rotate("+i.angle+"deg)";var n={position:t,offset:new BMap.Size(...i.offset),enableMassClear:i.enableMassClear},o=new BMap.Label(e.text,n);return o.setStyle(i),this.addAttributes(o,e),o},newCircle(e){var t=this.newPoint(e.center),i=new BMap.Circle(t,e.radius,e.circleStyle);return this.addAttributes(i,e),i},newpPolyline(e){var t=[];JM_util.isArray(e.points[0])?e.points.forEach(e=>{t.push(this.newPoint(e))}):t=e.points;var i=new BMap.Polyline(t,e.polylineStyle);return this.addAttributes(i,e),i},newCurveLine(e){var t=[];JM_util.isArray(e.points[0])?e.points.forEach(e=>{t.push(this.newPoint(e))}):t=e.points;var i=new BMapLib.CurveLine(t,e.CurveLineStyle);return this.addAttributes(i,e),i},newPolygon(e){var t=[];e.points.forEach(e=>{t.push(this.newPoint(e))});var i=new BMap.Polygon(t,e.polygonStyle);return this.addAttributes(i,e),i},newDrivingRoute(e,t){var i=new BMap.DrivingRoute(e,t);return i},newLuShu(e,t,i){var n=i.option;n.icon=this.newIcon(i.icon);var o=new BMapLib.LuShu(e,t,n);return o},addAttributes:(e,t)=>(e.id=t.id,e.info=t,e.overlayType=t.overlayType,"label"!==e.overlayType&&(e.edit=!0),e),setPolygonStyle(e,t){e.setStrokeWeight(t.strokeWeight),e.setStrokeColor(t.strokeColor),e.setStrokeOpacity(t.strokeOpacity),e.setStrokeStyle(t.strokeStyle),e.setFillColor(t.fillColor),e.setFillOpacity(t.fillOpacity)},setPolylineStyle(e,t){e.setStrokeWeight(t.strokeWeight),e.setStrokeColor(t.strokeColor),e.setStrokeOpacity(t.strokeOpacity),e.setStrokeStyle(t.strokeStyle)},showInfoWin(e,t,i){var n=this.creatPoint(t),o={point:n,offset:i.offset,type:i.type,width:i.width,title:t.title||i.title,img:t.img,imgSize:i.imgSize,content:t.content,button:i.button,info:t,contentHtml:t.contentHtml,customClass:i.customClass};e.show(o)},showContextMenu(e,t){var i=this.creatPoint(t),n={point:i,menuItem:t.menuItem,info:t,customClass:t.customClass};e.show(n)},clearOverlays(e,t){var i=e.getOverlays();i.forEach(i=>{t.includes(i.id)&&e.removeOverlay(i)})},clearClusterOverlays(e,t){var i=e.getMarkers(),n=[];i.forEach(e=>{t.includes(e.id)&&n.push(e)}),e.removeMarkers(n)},getEditOverlays(e){var t=e.getOverlays(),i=[];return t.forEach(e=>{e.edit&&i.push(e)}),i},getOverlayById(e,t){var i=e.getOverlays(),n=null;return i.forEach(e=>{e.id===t&&(n=e)}),n},getSymbolShapeType(e){var t=[{value:BMap_Symbol_SHAPE_CIRCLE,type:"圆形"},{value:BMap_Symbol_SHAPE_RECTANGLE,type:"矩形"},{value:BMap_Symbol_SHAPE_RHOMBUS,type:"菱形"},{value:BMap_Symbol_SHAPE_STAR,type:"五角星"},{value:BMap_Symbol_SHAPE_BACKWARD_CLOSED_ARROW,type:"方向向下的闭合箭头"},{value:BMap_Symbol_SHAPE_FORWARD_CLOSED_ARROW,type:"方向向上的闭合箭头"},{value:BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW,type:"方向向下的非闭合箭头"},{value:BMap_Symbol_SHAPE_FORWARD_OPEN_ARROW,type:"方向向上的非闭合箭头"},{value:BMap_Symbol_SHAPE_POINT,type:"定位点图标"},{value:BMap_Symbol_SHAPE_PLANE,type:"飞机形状"},{value:BMap_Symbol_SHAPE_CAMERA,type:"照相机形状"},{value:BMap_Symbol_SHAPE_WARNING,type:"警告符号"},{value:BMap_Symbol_SHAPE_SMILE,type:"笑脸形状"},{value:BMap_Symbol_SHAPE_CLOCK,type:"钟表形状"}],i=null;return t.forEach(t=>{t.type===e&&(i=t.value)}),i},loadJScript(e,t,i){var n=document.createElement("script");n.type=i||"text/javascript",n.src=e,t&&(n.onload=function(){t()}),document.head.appendChild(n)},centerAndOpenInfoWindow(e,t,i,n){var o=this,a=this.creatPoint(i);t.hide(),e.panTo(a),setTimeout(function(){o.showInfoWin(t,i,n)},300)}},JM_stylesB=[{style:"normal",label:"默认风格"},{style:"light",label:"清新蓝风格"},{style:"dark",label:"黑夜风格"},{style:"redalert",label:"红色警戒风格"},{style:"googlelite",label:"精简风格"},{style:"grassgreen",label:"自然绿风格"},{style:"midnight",label:"午夜蓝风格"},{style:"pink",label:"浪漫粉风格"},{style:"darkgreen",label:"青春绿风格"},{style:"bluish",label:"清新蓝绿风格"},{style:"grayscale",label:"高端灰风格"},{style:"hardedge",label:"强边界风格"}];let JM_InfoWin=function(e){this.overlayType="InfoWin",this._default=Object.assign({},e),this._option=Object.assign({},e)};JM_InfoWin.prototype=new BMap.Overlay,JM_InfoWin.prototype.initialize=function(e){this._map=e;var t=document.createElement("div");return t.setAttribute("id","icMapInfoWin"),t.setAttribute("class","ic-map-infoWin"),e.getPanes().floatPane.appendChild(t),this._div=t,t},JM_InfoWin.prototype.draw=function(){var e=this._map.pointToOverlayPixel(this._option.point);this._div.setAttribute("class","ic-map-infoWin "+this._option.customClass),this._div.style.width=this._option.width+"px",this._div.style.left=e.x-this._option.offset[0]+"px",this._div.style.top=e.y-this._option.offset[1]+"px"},JM_InfoWin.prototype.show=function(e){var t=this;this._option=JM_util.mergeObjectDeep(this._default,e),this._div&&(this._div.style.display="block",this._div.innerHTML=createInfoWinHtml(this._option),this.draw(),document.getElementById("icMapInfoWinCancleBtn").onclick=function(){t.hide()},document.getElementById("icMapInfoWin").ondblclick=function(e){var t=e||event;t.cancelBubble=!0,t.stopPropagation()},this._option.button.length&&this._option.button.forEach(e=>{document.getElementById(e.id).onclick=function(){e.clickEvent(t._option.info)}}))},JM_InfoWin.prototype.hide=function(){if(this._div){var e=this._map.pointToOverlayPixel(this._default.point);this._div.style.left=e.x+"px",this._div.style.top=e.y+"px",this._div.style.display="none"}};let JM_ContextMenu=function(e){this.overlayType="ContextMenu",this._default=e,JM_util.checkNull(e)?this._option=JM_util.mergeObjectDeep(this._default,e):this._option=Object.assign({},this._default)};JM_ContextMenu.prototype=new BMap.Overlay,JM_ContextMenu.prototype.initialize=function(e){this._map=e;var t=document.createElement("div");return t.setAttribute("id","icMapContextMenu"),t.setAttribute("class","ic-map-contextMenu"),e.getPanes().labelPane.appendChild(t),this._div=t,t},JM_ContextMenu.prototype.draw=function(){var e=this._map.pointToOverlayPixel(this._option.point);this._div.setAttribute("class","ic-map-contextMenu "+this._option.customClass),this._div.style.left=e.x+"px",this._div.style.top=e.y+"px"},JM_ContextMenu.prototype.show=function(e){var t=this;this._option=JM_util.mergeObjectDeep(this._default,e),this._div&&(this._div.style.display="block",this._div.innerHTML=createMemuHtml(this._option),this.draw(),document.getElementById("icMapContextMenu").ondblclick=function(e){var t=e||event;t.cancelBubble=!0,t.stopPropagation()},document.onclick=function(e){t.hide()},this._option.menuItem.length&&this._option.menuItem.forEach(e=>{document.getElementById(e.id).onclick=function(){t.hide(),e.clickEvent(t._option.info)}}))},JM_ContextMenu.prototype.hide=function(){if(this._div){var e=this._map.pointToOverlayPixel(this._default.point);this._div.style.left=e.x+"px",this._div.style.top=e.y+"px",this._div.style.display="none"}};let JM_map=function(){let e={isMapLoad:!0,baseMap:{},infoWin:{},icContextMenu:{},mapStyle:"normal",viewMode:"2D",mapTypeNow:BMAP_NORMAL_MAP,option:{},Api:{TrafficControl:"http://api.map.baidu.com/library/TrafficControl/1.4/src/TrafficControl_min.js",Heatmap:"http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js",TextIconOverlay:"http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js",MarkerClusterer:"http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js",DrawingManager:"http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js",CurveLine:"http://api.map.baidu.com/library/CurveLine/1.5/src/CurveLine.min.js",LuShu:"http://api.map.baidu.com/library/LuShu/1.2/src/LuShu_min.js",DistanceTool:"http://api.map.baidu.com/library/DistanceTool/1.2/src/DistanceTool.js"},status:{edit:!1,draw:!1,measure:!1,coordinate:!1,cluster:!1},DrawingType:null,modules:{boundary:{},traffic:{},heatMap:{},cluster:{},drawing:{},distanceTool:{},diving:[],lushu:[]},init(e){let t=this;this.option=JM_util.deepCopy(e),0===this.option.icBoundary.polygonStyle.strokeOpacity&&(this.option.icBoundary.polygonStyle.strokeOpacity="0"),0===this.option.icBoundary.polygonStyle.fillOpacity&&(this.option.icBoundary.polygonStyle.fillOpacity="0"),0===this.option.icBoundary.hover.polygonStyle.strokeOpacity&&(this.option.icBoundary.hover.polygonStyle.strokeOpacity="0"),0===this.option.icBoundary.hover.polygonStyle.fillOpacity&&(this.option.icBoundary.hover.polygonStyle.fillOpacity="0"),this.option.mapType=this.convertMapType(this.option.viewMode),this.baseMap=new BMap.Map(this.option.id,this.option),this.viewMode=this.option.viewMode,this.DrawingType=this.option.icDrawControl.defaultType,this.baseMap.setMapStyle({style:this.option.mapStyle}),this.baseMap.setCurrentCity(this.option.area),this.baseMap.centerAndZoom(JM_B_util.newPoint(this.option.center),this.option.zoom),this.baseMap.enableScrollWheelZoom(this.option.enableScrollWheelZoom),this.option.enableDragging?this.baseMap.enableDragging():this.baseMap.disableDragging(),this.option.enableDoubleClickZoom?this.baseMap.enableDoubleClickZoom():this.baseMap.disableDoubleClickZoom(),JM_util.checkNull(this.option.extent)&&JM_B_util.loadJScript("http://api.map.baidu.com/library/AreaRestriction/1.2/src/AreaRestriction_min.js",function(){t.initExtent()}),this.initComponents(),this.bindEvents()},initComponents(){let e=this;this.initInfoWin(),this.infoWin.hide(),this.initContextMenu(),this.initScaleControl(),this.initNavigationControl(),this.initOverviewMapControl(),this.option.icCurveLine.isUsed&&JM_B_util.loadJScript(this.Api.CurveLine),this.option.icDrawControl.isUsed&&JM_B_util.loadJScript(this.Api.DrawingManager,function(){e.newDrawModule()}),this.option.icDistanceTool.isUsed&&JM_B_util.loadJScript(this.Api.DistanceTool,function(){e.newDistanceTool()}),this.option.icLuShu.isUsed&&JM_B_util.loadJScript(this.Api.LuShu),this.option.icToolBar.layout.includes("traffic")&&JM_B_util.loadJScript(this.Api.TrafficControl),this.option.icHeatMap.isUsed&&JM_B_util.loadJScript(this.Api.Heatmap,function(){e.newHeatMapModule()}),this.option.icCluster.isUsed&&(JM_B_util.loadJScript(this.Api.TextIconOverlay),JM_B_util.loadJScript(this.Api.MarkerClusterer,function(){e.newClusterModule()})),this.option.icBoundary.isUsed&&this.newBoundaryModule()},bindEvents(){let e=this;this.baseMap.addEventListener("tilesloaded",function(){e.isMapLoad&&(e.option.mapOnloadFunc&&e.option.mapOnloadFunc(),e.option.icMapOnloadFunc&&e.option.icMapOnloadFunc(),e.isMapLoad=!1)}),this.baseMap.addEventListener("click",function(t){e.status.coordinate&&e.option.listenerFunc("coordinate",t.point.lng+","+t.point.lat)}),this.baseMap.addEventListener("rightclick",function(t){if(e.icContextMenu.isTargetMap){let i={lng:t.point.lng,lat:t.point.lat,menuItem:e.option.icMapContextMenu.menuItem,info:"",customClass:e.option.icMapContextMenu.customClass};JM_B_util.showContextMenu(e.icContextMenu,i)}e.icContextMenu.isTargetMap=!0}),this.baseMap.addEventListener("dragend",function(t){e.option.listenerFunc("dragend",t)}),this.baseMap.addEventListener("zoomend",function(t){e.option.listenerFunc("zoomend",t)})},initExtent(){let e=new BMap.Bounds(JM_B_util.newPoint(this.option.extent[0]),JM_B_util.newPoint(this.option.extent[1]));try{BMapLib.AreaRestriction.setBounds(this.baseMap,e)}catch(e){alert(e)}},initInfoWin(){this.option.infoWinOption.point=JM_B_util.newPoint(this.option.infoWinOption.point),this.infoWin=new JM_InfoWin(this.option.infoWinOption),this.baseMap.addOverlay(this.infoWin)},initContextMenu(){this.icContextMenu=new JM_ContextMenu(this.option.ContextMenuOption),this.icContextMenu.isTargetMap=!0,this.baseMap.addOverlay(this.icContextMenu)},initScaleControl(){let e=this.option.scaleControl;if(e.show){let t={};t.anchor=JM_util.evil("BMAP_ANCHOR_"+e.position[0]+"_"+e.position[1]),t.offset={width:e.x,height:e.y},this.baseMap.addControl(new BMap.ScaleControl(t))}},initNavigationControl(){let e=this.option.navigationControl;if(e.show){let t={};t.anchor=JM_util.evil("BMAP_ANCHOR_"+e.position[0]+"_"+e.position[1]),t.offset={width:e.x,height:e.y},this.baseMap.addControl(new BMap.NavigationControl(t))}},initOverviewMapControl(){let e=this.option.overviewMapControl;if(e.show){let t={};t.isOpen=e.open,t.anchor=JM_util.evil("BMAP_ANCHOR_"+e.position[0]+"_"+e.position[1]),t.offset={width:e.x,height:e.y},this.baseMap.addControl(new BMap.OverviewMapControl(t))}},newHeatMapModule(){this.modules.heatMap=new BMapLib.HeatmapOverlay(this.option.icHeatMap.option),this.modules.heatMap.overlayType="heatMap",this.baseMap.addOverlay(this.modules.heatMap)},newClusterModule(){this.option.icCluster.styles[0].size=new BMap.Size(...this.option.icCluster.styles[0].size),this.option.icCluster.styles[0].offset=new BMap.Size(...this.option.icCluster.styles[0].offset),this.modules.cluster=new BMapLib.MarkerClusterer(this.baseMap,this.option.icCluster)},newBoundaryModule(){let e=this;this.modules.boundary=new BMap.Boundary;let t=this.option.icBoundary.area;t.forEach(t=>{this.modules.boundary.get(t,function(i){let n=i.boundaries.length;if(0===n)alert("未能获取当前设置的行政区域，无法展示区域边界！");else{let o=[];for(let a=0;a<n;a++){let n=e.createBoundary(i.boundaries[a],e.option.icBoundary);n.areaName=t,e.baseMap.addOverlay(n),o=o.concat(n.getPath())}}})})},createBoundary(e,t){let i=new BMap.Polygon(e,t.polygonStyle);return t.hover.isUsed&&(i.addEventListener("mouseover",function(e){JM_util.checkNull(t.hover.func)&&t.hover.func(i.areaName),JM_B_util.setPolygonStyle(e.target,t.hover.polygonStyle)}),i.addEventListener("mouseout",function(e){JM_B_util.setPolygonStyle(e.target,t.polygonStyle)})),i.overlayType="boundary",i},getDrivingPath(e,t,i,n,o,a){let l=this,s=JM_util.uuid();JM_util.checkNull(a)&&(this.option.icDriving=JM_util.mergeObjectDeep(this.option.icDriving,a));let r=this.modules.diving.length;this.modules.diving[r]={id:s,drivingRoute:[],path:[]};let p=this.modules.diving[r],c=function(e){l.addPathPoints(l,e,s),p.path=l.addPathLine(l,e,s,o),i&&(n?l.addLuShu(l,e,a):l.addRunAction(l,e,s,i))},u=[];u[0]={policy:BMAP_DRIVING_POLICY_FIRST_HIGHWAYS},u[1]={policy:BMAP_DRIVING_POLICY_AVOID_HIGHWAYS},u[2]={policy:BMAP_DRIVING_POLICY_AVOID_CONGESTION},u[3]={policy:BMAP_DRIVING_POLICY_DEFAULT};for(let e=0;e<4;e++)u[e].onSearchComplete=c,p.drivingRoute[e]=JM_B_util.newDrivingRoute(this.baseMap,u[e]);let h=JM_B_util.newPoint(e),d=JM_B_util.newPoint(t);switch(o){case"优先高速":p.drivingRoute[0].search(h,d);break;case"避开高速":p.drivingRoute[1].search(h,d);break;case"避开拥堵":p.drivingRoute[2].search(h,d);break;case"all":for(let e=0;e<4;e++)p.drivingRoute[e].search(h,d);break;default:p.drivingRoute[3].search(h,d)}},addPathPoints(e,t,i){let n={id:i+"_start",overlayType:"marker",point:t.getStart().point,markerStyle:e.option.icDriving.startIcon,title:"起点"},o={id:i+"_end",overlayType:"marker",point:t.getEnd().point,markerStyle:e.option.icDriving.endIcon,title:"终点"},a=this.createOverlay(n,!0),l=this.createOverlay(o,!0);a.drivingAttr=!0,l.drivingAttr=!0,e.baseMap.addOverlay(a),e.baseMap.addOverlay(l)},addPathLine(e,t,i,n){let o=[],a=1;"all"===n&&(a=t.getNumPlans());for(let n=0;n<a;n++){let a=t.getPlan(n).getRoute(n).getPath(),l={id:i+"_line_"+JM_util.uuid(),overlayType:"polyline",points:a,polylineStyle:e.option.icDriving.pathStyle,hoverStyle:e.option.icDriving.pathHoverStyle,drivingAttr:!0};o.push(l);let s=this.createOverlay(l);s.drivingAttr=!0,e.baseMap.addOverlay(s)}return o},addRunAction(e,t,i,n){let o={id:i+"_run",overlayType:"marker",point:t.getStart().point,markerStyle:e.option.icDriving.runIcon,title:e.option.icDriving.runIconTitle},a=this.createOverlay(o,!0);a.drivingAttr=!0,e.baseMap.addOverlay(a);let l=t.getPlan(0).getRoute(0).getPath();e.baseMap.setViewport(l),l.forEach((t,i)=>{e.reSetPosition(a,t,i,n)})},reSetPosition(e,t,i,n){setTimeout(function(){e.setPosition(t)},n*i)},addLuShu(e,t,i){console.log(i);let n=e.option.icLuShu;JM_util.checkNull(i)&&(n=JM_util.mergeObjectDeep(e.option.icLuShu,i));let o=t.getPlan(0).getRoute(0).getPath(),a=e.modules.lushu.length;e.modules.lushu[a]=JM_B_util.newLuShu(e.baseMap,o,n)},setLuShuAction(e){switch(e){case"start":this.modules.lushu.forEach(e=>{e.start(),e._marker.overlayType="marker",e._marker.drivingAttr=!0});break;case"stop":this.modules.lushu.forEach(e=>{e.stop()});break;case"pause":this.modules.lushu.forEach(e=>{e.pause()});break;case"showInfoWindow":this.modules.lushu.forEach(e=>{e.showInfoWindow()});break;case"hideInfoWindow":this.modules.lushu.forEach(e=>{e.hideInfoWindow()})}},clearDrivingPath(){let e=this,t=this.baseMap.getOverlays();t.forEach(t=>{t.drivingAttr&&e.baseMap.removeOverlay(t)}),this.modules.diving=[],this.modules.lushu=[]},setMapStyle(e){this.baseMap.setMapStyle({style:e})},setMapType(e){e!==this.viewMode&&(this.viewMode=e,this.baseMap.setMapType(this.convertMapType(e)))},convertMapType(e){switch(e){case"2D":return BMAP_NORMAL_MAP;case"3D":return BMAP_PERSPECTIVE_MAP;case"卫星":return BMAP_HYBRID_MAP;case"卫星无路网":return BMAP_SATELLITE_MAP}},setTrafficControl(e){e?(this.modules.traffic=new BMap.TrafficLayer,this.baseMap.addTileLayer(this.modules.traffic)):this.baseMap.removeTileLayer(this.modules.traffic)},setCoordinateStatus(e){this.status.coordinate=e},setEditStatus(e){this.status.edit=e;let t=JM_B_util.getEditOverlays(this.baseMap),i=["circle","polyline","polygon","rectangle"];if(e&&!t.length)return!1;if(e&&t.length)this.modules.drawing.close(),t.forEach(e=>{"marker"===e.overlayType&&e.enableDragging(),i.includes(e.overlayType)&&(e.enableEditing(),e.isEditing=!0)});else if(!e&&t.length){this.status.draw&&(this.modules.drawing.open(),this.modules.drawing.setDrawingMode(this.DrawingType));let e=[];if(t.forEach(t=>{"marker"===t.overlayType&&t.disableDragging(),i.includes(t.overlayType)&&(t.disableEditing(),t.isEditing=!1,t.lineupdate&&e.push(t))}),e.length)return e}return!0},newDistanceTool(){let e=this;this.modules.distanceTool=new BMapLib.DistanceTool(this.baseMap,this.option.icDistanceTool),this.modules.distanceTool.addEventListener("drawend",function(t){e.option.listenerFunc("DistanceTool",t)})},setDistanceToolStatus(e){e?this.modules.distanceTool.open():this.modules.distanceTool.close()},newDrawModule(){let e={icon:JM_B_util.newIcon(this.option.markerStyle),offset:new BMap.Size(...[0,-.5*this.option.markerStyle.imageSize[1]])},t={isOpen:!1,drawingType:this.DrawingType,enableCalculate:!1,markerOptions:e,circleOptions:this.option.circleStyle,polylineOptions:this.option.polylineStyle,polygonOptions:this.option.polygonStyle,rectangleOptions:this.option.polygonStyle};this.modules.drawing=new BMapLib.DrawingManager(this.baseMap,t),this.bindCompleteEvent()},bindCompleteEvent(){let e=this,t=["markercomplete","circlecomplete","polylinecomplete","polygoncomplete","rectanglecomplete"],i=["marker","circle","polyline","polygon","rectangle"];t.forEach((t,n)=>{e.modules.drawing.addEventListener(t,function(t,o){let a=i[n];o.overlayType=a,o.edit=!0,o.drawing=!0,JM_util.checkNull(e.option.icDrawControl.completeFunc[a])&&e.option.icDrawControl.completeFunc[a](o),e.newDrawModule(),e.setDrawStatus(!0)})})},setDrawStatus(e){this.status.draw=e,e?(this.modules.drawing.open(),this.modules.drawing.setDrawingMode(this.DrawingType)):this.modules.drawing.close()},setDrawMode(e){switch(e){case"marker":this.DrawingType=BMAP_DRAWING_MARKER;break;case"circle":this.DrawingType=BMAP_DRAWING_CIRCLE;break;case"polyline":this.DrawingType=BMAP_DRAWING_POLYLINE;break;case"polygon":this.DrawingType=BMAP_DRAWING_POLYGON;break;case"rectangle":this.DrawingType=BMAP_DRAWING_RECTANGLE;break;case"clear":this.clearAllDraw()}this.modules.drawing.setDrawingMode(this.DrawingType)},clearAllDraw(){let e=this,t=this.baseMap.getOverlays();t.forEach(t=>{t.drawing&&e.baseMap.removeOverlay(t)})},showOverlays(e,t,i){this.hideInfoWin(),this.hideContextMenu(),this.checkRepeatOverlays(e,t)?"heatMap"===t?this.showHeatMap(e,i):this.showOtherOverlays(e,t,i):alert("覆盖物id是唯一标识，不可重复！")},checkRepeatOverlays(e,t){if("heatMap"===t)return!0;let i=[];return e.forEach(e=>{i.push(e.id)}),JM_util.checkRepeat(i)},showHeatMap(e,t,i){if(t)if(!JM_util.checkNull(this.modules.heatMap.data)||i){let t=e[0].max;this.modules.heatMap.setDataSet({data:e,max:t}),this.modules.heatMap.show()}else this.modules.heatMap.show();else this.modules.heatMap.hide()},showOtherOverlays(e,t,i){let n=this;if(i)e.forEach(e=>{let i=n.createOverlay(e);n.option.icCluster.isUsed&&"marker"===t?n.modules.cluster.addMarker(i):(n.baseMap.addOverlay(i),JM_util.checkNull(e.animationType)&&"marker"===t&&this.addAnimation(i,e.animationType))});else{let i=[];e.forEach(e=>{i.push(e.id)}),n.option.icCluster.isUsed&&"marker"===t?JM_B_util.clearClusterOverlays(n.modules.cluster,i):JM_B_util.clearOverlays(n.baseMap,i)}},addAnimation(e,t){"bounce"===t?e.setAnimation(BMAP_ANIMATION_BOUNCE):e.setAnimation(BMAP_ANIMATION_DROP)},createOverlay(e){this.uniqueOverlay(e.id);let t=e.overlayType+"Style";e[t]=JM_util.mergeObjectDeep(this.option[t],e[t]||{}),e.normalStyle=e[t],e.hoverStyle&&(e.hoverStyle=JM_util.mergeObjectDeep(e.normalStyle,e.hoverStyle)),e.infoWinStyle=JM_util.mergeObjectDeep(this.option.infoWinOption,e.infoWinStyle||{});let i=null;switch(e.overlayType){case"marker":i=JM_B_util.newMarker(e);break;case"label":i=JM_B_util.newLabel(e);break;case"circle":i=JM_B_util.newCircle(e);break;case"polyline":i=JM_B_util.newpPolyline(e);break;case"polygon":i=JM_B_util.newPolygon(e);break;case"AdvancedLabel":e.point=JM_B_util.newPoint(e.center),i=new AdvancedLabel(e);break;case"CurveLine":i=JM_B_util.newCurveLine(e)}return this.bindOverlayEvent(i,e),i},uniqueOverlay(e){JM_B_util.clearOverlays(this.baseMap,[e]),this.option.icCluster.isUsed&&JM_B_util.clearClusterOverlays(this.modules.cluster,[e])},bindOverlayEvent(e,t){let i=this;e.addEventListener("mouseover",function(){JM_util.checkNull(t.mouseoverEvent)&&t.mouseoverEvent(e.info),JM_util.checkNull(t.hoverStyle)&&i.setOverlayStyle(t.id,t.hoverStyle)}),e.addEventListener("mouseout",function(){JM_util.checkNull(t.mouseleaveEvent)&&t.mouseleaveEvent(e.info),JM_util.checkNull(t.hoverStyle)&&i.setOverlayStyle(t.id,t.normalStyle)}),e.addEventListener("click",function(){t.stopDefaultClickEvent||($("#"+i.option.domId).attr("val",JSON.stringify(t)),i.centerAndOpenInfoWindow(t,t.infoWinStyle)),JM_util.checkNull(t.clickEvent)&&t.clickEvent(e.info)}),e.addEventListener("rightclick",function(e){if(i.icContextMenu.isTargetMap=!1,i.icContextMenu.hide(),t.contextMenu&&t.contextMenu.isUsed){let e={lng:t.lng,lat:t.lat,menuItem:t.contextMenu.menuItem,info:t,customClass:t.contextMenu.customClass};JM_B_util.showContextMenu(i.icContextMenu,e)}}),"marker"===e.overlayType&&e.addEventListener("dragend",function(i){t.dragendEvent?t.dragendEvent(i.point,e.info):console.log("未定义拖拽后执行的方法")});let n=["circle","polyline","polygon","rectangle"];n.includes(e.overlayType)&&e.addEventListener("lineupdate",function(t){e.isEditing&&(e.lineupdate=!0)})},setOverlayStyle(e,t){let i=JM_B_util.getOverlayById(this.baseMap,e),n=i.overlayType;switch(n){case"marker":let e=JM_B_util.newIcon(t);i.setIcon(e);break;case"circle":JM_B_util.setPolygonStyle(i,t);break;case"polyline":case"CurveLine":JM_B_util.setPolylineStyle(i,t);break;case"polygon":JM_B_util.setPolygonStyle(i,t);break;case"label":i.setStyle(t)}},hideInfoWin(){this.infoWin.hide()},hideContextMenu(){this.icContextMenu.hide()},clearAllOverlays(){let e=this,t=["InfoWin","ContextMenu","heatMap"],i=this.baseMap.getOverlays();console.log(i),i.forEach(i=>{t.includes(i.overlayType)?i.hide():e.baseMap.removeOverlay(i)})},centerAndOpenInfoWindow(e,t){JM_B_util.centerAndOpenInfoWindow(this.baseMap,this.infoWin,e,t)},zoomToFunc(e){this.baseMap.setZoom(e)},panToFunc(e,t){let i=JM_util.isArray(e)?JM_B_util.newPoint(e):e,n=t||this.baseMap.getZoom();this.baseMap.centerAndZoom(i,n)},getOverlayById(e){return JM_B_util.getOverlayById(this.baseMap,e)},getZoom(){return this.baseMap.getZoom()}};return e};